<html>

<head>
  <title>Secrets</title>
</head>

<body>
  <div x-data="secretsEditor()">
    <template x-if="$store.settings.settings">
      <div>
        <div class="section-title">Secrets Management</div>
        <div class="section-description">
          Manage secrets and credentials that agents can use without exposing values to LLMs, chat history or logs.
          Placeholders are automatically replaced with values just before tool calls. If bare passwords occur in tool
          results, they are masked back to placeholders.
        </div>

        <!-- ==================== VARIABLES STORE ==================== -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1.5em;">
          <div>
            <div class="section-title" style="margin: 0; font-size: 0.95em;">Variables Store</div>
            <div class="section-description" style="margin: 0; font-size: 0.8em; opacity: 0.7;">
              Non-sensitive variables visible to LLMs. Not masked.
            </div>
          </div>
          <div>
            <a href="#" @click.prevent="varRawMode = !varRawMode"
              style="font-size: 0.75em; color: var(--color-accent, #4fc3f7);"
              x-text="varRawMode ? 'Editor mode' : 'Raw mode'"></a>
          </div>
        </div>

        <!-- Variables RAW mode -->
        <div class="field field-full" x-show="varRawMode" style="margin-top: 0.5em;">
          <div class="field-control">
            <textarea style="height: 16em; font-family: monospace; font-size: 0.85em;"
              x-model="$store.settings.settings.variables"></textarea>
          </div>
        </div>

        <!-- Variables EDITOR mode -->
        <div x-show="!varRawMode" style="margin-top: 0.5em;">
          <template x-for="(row, idx) in varRows" :key="idx">
            <div x-show="!row.isComment" class="field" style="margin-bottom: 4px;">
              <div class="field-control" style="display: flex; gap: 8px; align-items: center; width: 100%;">
                <input type="text" x-model="row.key" @input="serializeVars()" placeholder="KEY"
                  style="flex: 0.4; font-family: monospace; font-size: 0.85em;" />
                <input type="text" x-model="row.value" @input="serializeVars()" placeholder="value"
                  style="flex: 0.6; font-family: monospace; font-size: 0.85em;" />
                <button @click="varRows.splice(idx, 1); serializeVars()" class="btn"
                  style="padding: 4px 8px; font-size: 0.8em; min-width: auto; background: transparent; color: #ff6b6b; border: 1px solid #ff6b6b33;"
                  title="Delete">&#10005;</button>
              </div>
            </div>
          </template>
          <button @click="varRows.push({ key: '', value: '', isComment: false })" class="btn"
            style="margin-top: 8px; padding: 6px 16px; font-size: 0.8em; background: #1a3a4a; color: #4fc3f7; border: 1px solid #4fc3f733;">
            + Add Variable
          </button>
        </div>

        <!-- ==================== SECRETS STORE ==================== -->
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 2em;">
          <div>
            <div class="section-title" style="margin: 0; font-size: 0.95em;">Secrets Store</div>
            <div class="section-description" style="margin: 0; font-size: 0.8em; opacity: 0.7;">
              Sensitive credentials masked in LLM output and logs. Only values with length &gt;= 4 are masked.
            </div>
          </div>
          <div>
            <a href="#" @click.prevent="secRawMode = !secRawMode"
              style="font-size: 0.75em; color: var(--color-accent, #4fc3f7);"
              x-text="secRawMode ? 'Editor mode' : 'Raw mode'"></a>
          </div>
        </div>

        <!-- Secrets RAW mode -->
        <div class="field field-full" x-show="secRawMode" style="margin-top: 0.5em;">
          <div class="field-control">
            <textarea style="height: 16em; font-family: monospace; font-size: 0.85em;"
              x-model="$store.settings.settings.secrets"></textarea>
          </div>
        </div>

        <!-- Secrets EDITOR mode -->
        <div x-show="!secRawMode" style="margin-top: 0.5em;">
          <template x-for="(row, idx) in secRows" :key="idx">
            <div x-show="!row.isComment" class="field" style="margin-bottom: 4px;">
              <div class="field-control" style="display: flex; gap: 8px; align-items: center; width: 100%;">
                <input type="text" x-model="row.key" @input="serializeSecs()" placeholder="SECRET_KEY"
                  style="flex: 0.4; font-family: monospace; font-size: 0.85em;" />
                <div style="flex: 0.6; position: relative; display: flex; align-items: center;">
                  <input :type="secRevealed[idx] ? 'text' : 'password'" x-model="row.value" @input="serializeSecs()"
                    placeholder="secret value"
                    style="width: 100%; font-family: monospace; font-size: 0.85em; padding-right: 32px;" />
                  <button @click="secRevealed[idx] = !secRevealed[idx]"
                    style="position: absolute; right: 4px; background: none; border: none; cursor: pointer; font-size: 0.9em; opacity: 0.6; padding: 2px 4px;"
                    :title="secRevealed[idx] ? 'Hide' : 'Reveal'"
                    x-text="secRevealed[idx] ? '&#128584;' : '&#128065;'"></button>
                </div>
                <button @click="secRows.splice(idx, 1); serializeSecs()" class="btn"
                  style="padding: 4px 8px; font-size: 0.8em; min-width: auto; background: transparent; color: #ff6b6b; border: 1px solid #ff6b6b33;"
                  title="Delete">&#10005;</button>
              </div>
            </div>
          </template>
          <button @click="secRows.push({ key: '', value: '', isComment: false })" class="btn"
            style="margin-top: 8px; padding: 6px 16px; font-size: 0.8em; background: #1a3a4a; color: #4fc3f7; border: 1px solid #4fc3f733;">
            + Add Secret
          </button>
        </div>
      </div>
    </template>
  </div>
</body>

<script>
  function secretsEditor() {
    return {
      varRows: [],
      varRawMode: false,
      _varWriting: false,
      secRows: [],
      secRawMode: false,
      _secWriting: false,
      secRevealed: {},

      init() {
        this.parseVars();
        this.parseSecs();
        this.$watch('$store.settings.settings.variables', () => {
          if (!this._varWriting) this.parseVars();
        });
        this.$watch('$store.settings.settings.secrets', () => {
          if (!this._secWriting) this.parseSecs();
        });
      },

      parseEnv(raw) {
        var rows = [];
        var lines = (raw || '').split('\n');
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (!line) continue;
          if (line.charAt(0) === '#') {
            rows.push({ key: '', value: line, isComment: true });
            continue;
          }
          var eqIdx = line.indexOf('=');
          if (eqIdx === -1) {
            rows.push({ key: line, value: '', isComment: false });
          } else {
            var key = line.substring(0, eqIdx).trim();
            var val = line.substring(eqIdx + 1).trim();
            if (val.length >= 2) {
              var first = val.charAt(0);
              var last = val.charAt(val.length - 1);
              if ((first === '"' && last === '"') || (first === "'" && last === "'")) {
                val = val.substring(1, val.length - 1);
              }
            }
            rows.push({ key: key, value: val, isComment: false });
          }
        }
        return rows;
      },

      serializeEnv(rows) {
        var lines = [];
        for (var i = 0; i < rows.length; i++) {
          var r = rows[i];
          if (r.isComment) { lines.push(r.value); continue; }
          if (!r.key && !r.value) continue;
          lines.push(r.key + '="' + r.value + '"');
        }
        return lines.join('\n');
      },

      parseVars() {
        var s = Alpine.store('settings');
        if (s && s.settings) {
          this.varRows = this.parseEnv(s.settings.variables);
        }
      },

      serializeVars() {
        this._varWriting = true;
        var s = Alpine.store('settings');
        if (s && s.settings) {
          s.settings.variables = this.serializeEnv(this.varRows);
        }
        var self = this;
        this.$nextTick(function () { self._varWriting = false; });
      },

      parseSecs() {
        var s = Alpine.store('settings');
        if (s && s.settings) {
          this.secRows = this.parseEnv(s.settings.secrets);
        }
      },

      serializeSecs() {
        this._secWriting = true;
        var s = Alpine.store('settings');
        if (s && s.settings) {
          s.settings.secrets = this.serializeEnv(this.secRows);
        }
        var self = this;
        this.$nextTick(function () { self._secWriting = false; });
      },
    };
  }
</script>

</html>