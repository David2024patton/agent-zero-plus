<html>

<head>
    <title>Sub-Agent Model</title>
</head>

<body>
    <div x-data="{
      useDropdown: false,
      fetchingModels: false,
      fetchError: '',
      modelOptions: [],
      _debounceTimer: null,

      async fetchModels() {
        const settings = $store.settings.settings;
        const provider = settings.subagent_model_provider;
        if (!provider) return;
        const apiKey = (settings.api_keys || {})[provider] || '';
        const apiBase = settings.subagent_model_api_base || '';

        if (!['ollama', 'lm_studio', 'nvidia'].includes(provider) && apiKey.length < 10) return;

        this.fetchingModels = true;
        this.fetchError = '';
        try {
          const csrfToken = await window.getCsrfToken();
          const resp = await fetch('/models_list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
            body: JSON.stringify({ provider, api_key: apiKey, api_base: apiBase })
          });
          const data = await resp.json();
          if (data.ok && data.models?.length) {
            this.modelOptions = data.models;
            this.useDropdown = true;
          } else {
            this.fetchError = data.error || 'No models found';
            this.modelOptions = [];
            this.useDropdown = false;
          }
        } catch (e) {
          this.fetchError = 'Failed to connect';
          this.useDropdown = false;
        } finally {
          this.fetchingModels = false;
        }
      },

      debouncedFetch() {
        clearTimeout(this._debounceTimer);
        this._debounceTimer = setTimeout(() => this.fetchModels(), 800);
      },

      onSelectChange(e) {
        $store.settings.settings.subagent_model_name = e.target.value;
      },

      switchToManual() {
        this.useDropdown = false;
        this.modelOptions = [];
      },

      autoFillEndpoint() {
        const endpoints = {
          anthropic: 'https://api.anthropic.com/v1',
          deepseek: 'https://api.deepseek.com/v1',
          gemini: 'https://generativelanguage.googleapis.com/v1beta',
          google: 'https://generativelanguage.googleapis.com/v1beta',
          groq: 'https://api.groq.com/openai/v1',
          lm_studio: 'http://localhost:1234/v1',
          mistral: 'https://api.mistral.ai/v1',
          nvidia: 'https://integrate.api.nvidia.com/v1',
          ollama: 'http://localhost:11434/v1',
          openai: 'https://api.openai.com/v1',
          openrouter: 'https://openrouter.ai/api/v1',
        };
        const provider = $store.settings.settings.subagent_model_provider;
        if (provider && endpoints[provider] && !$store.settings.settings.subagent_model_api_base) {
          $store.settings.settings.subagent_model_api_base = endpoints[provider];
        }
      },

      init() {
        this.$watch('$store.settings.settings.subagent_model_provider', (val) => {
          this.autoFillEndpoint();
          this.debouncedFetch();
        });
        this.$watch('$store.settings.settings.api_keys', () => {
          this.debouncedFetch();
        });
      }
    }">
        <template x-if="$store.settings.settings">
            <div>
                <div class="section-title">Sub-Agent Model</div>
                <div class="section-description">
                    Model used by subordinate agents. Leave empty to use the main Chat Model.
                </div>

                <div class="field">
                    <div class="field-label">
                        <div class="field-title">Sub-agent model provider</div>
                        <div class="field-description">Select provider for sub-agent model. Leave empty to inherit from
                            Chat Model.</div>
                    </div>
                    <div class="field-control">
                        <select x-model="$store.settings.settings.subagent_model_provider">
                            <option value="">-- Use Chat Model --</option>
                            <template x-for="option in $store.settings.additional?.chat_providers" :key="option.value">
                                <option :value="option.value"
                                    :selected="option.value === $store.settings.settings.subagent_model_provider"
                                    x-text="option.label"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <div class="field">
                    <div class="field-label">
                        <div class="field-title">Sub-agent model name</div>
                        <div class="field-description">
                            <template x-if="useDropdown">
                                <span>Select from available models or
                                    <a href="#" @click.prevent="switchToManual()"
                                        style="color: var(--color-accent, #4fc3f7);">switch to manual entry</a>
                                </span>
                            </template>
                            <template x-if="!useDropdown">
                                <span>Exact name of model from selected provider.
                                    <a href="#" @click.prevent="fetchModels()"
                                        style="color: var(--color-accent, #4fc3f7);">Load available models</a>
                                </span>
                            </template>
                        </div>
                    </div>
                    <div class="field-control" style="display: flex; align-items: center; gap: 8px;">
                        <!-- Dropdown mode -->
                        <select x-show="useDropdown" @change="onSelectChange($event)" style="flex: 1;">
                            <option value="">-- Select a model --</option>
                            <template x-for="m in modelOptions" :key="m.id">
                                <option :value="m.id" :selected="m.id === $store.settings.settings.subagent_model_name"
                                    x-text="m.name || m.id"></option>
                            </template>
                        </select>
                        <!-- Manual input mode -->
                        <input x-show="!useDropdown" type="text" x-model="$store.settings.settings.subagent_model_name"
                            placeholder="Leave empty to use Chat Model" style="flex: 1;" />
                        <!-- Loading indicator -->
                        <span x-show="fetchingModels" style="font-size: 12px; opacity: 0.7;">‚è≥ Loading...</span>
                    </div>
                    <template x-if="fetchError && !useDropdown">
                        <div style="font-size: 11px; color: #ff6b6b; margin-top: 4px; padding-left: 4px;"
                            x-text="fetchError"></div>
                    </template>
                </div>

                <div class="field">
                    <div class="field-label">
                        <div class="field-title">API key</div>
                        <div class="field-description">API key for the selected sub-agent model provider (shared with
                            provider)</div>
                    </div>
                    <div class="field-control">
                        <input type="text"
                            x-model="$store.settings.settings.api_keys[$store.settings.settings.subagent_model_provider]"
                            autocomplete="off" :disabled="!$store.settings.settings.subagent_model_provider" />
                    </div>
                </div>

                <div class="field">
                    <div class="field-label">
                        <div class="field-title">Sub-agent model API base URL</div>
                        <div class="field-description">
                            API base URL for sub-agent model. Leave empty for default.
                        </div>
                    </div>
                    <div class="field-control">
                        <input type="text" x-model="$store.settings.settings.subagent_model_api_base" />
                    </div>
                </div>

                <div class="field">
                    <div class="field-label">
                        <div class="field-title">Sub-agent model context length</div>
                        <div class="field-description">
                            Maximum tokens in context window. Set to 0 to inherit from Chat Model.
                        </div>
                    </div>
                    <div class="field-control">
                        <input type="number" x-model.number="$store.settings.settings.subagent_model_ctx_length" />
                    </div>
                </div>

                <div class="field">
                    <div class="field-label">
                        <div class="field-title">Requests per minute limit</div>
                        <div class="field-description">
                            Limits requests per minute. Set to 0 to disable.
                        </div>
                    </div>
                    <div class="field-control">
                        <input type="number" x-model.number="$store.settings.settings.subagent_model_rl_requests" />
                    </div>
                </div>

                <div class="field">
                    <div class="field-label">
                        <div class="field-title">Input tokens per minute limit</div>
                        <div class="field-description">
                            Limits input tokens per minute. Set to 0 to disable.
                        </div>
                    </div>
                    <div class="field-control">
                        <input type="number" x-model.number="$store.settings.settings.subagent_model_rl_input" />
                    </div>
                </div>

                <div class="field">
                    <div class="field-label">
                        <div class="field-title">Output tokens per minute limit</div>
                        <div class="field-description">
                            Limits output tokens per minute. Set to 0 to disable.
                        </div>
                    </div>
                    <div class="field-control">
                        <input type="number" x-model.number="$store.settings.settings.subagent_model_rl_output" />
                    </div>
                </div>

                <div class="field field-full">
                    <div class="field-label">
                        <div class="field-title">Sub-agent model additional parameters</div>
                        <div class="field-description">
                            Any other parameters supported by <a href='https://docs.litellm.ai/docs/set_keys'
                                target='_blank'>LiteLLM</a>. Format is KEY=VALUE on individual lines.
                        </div>
                    </div>
                    <div class="field-control">
                        <textarea x-model="$store.settings.settings.subagent_model_kwargs"></textarea>
                    </div>
                </div>
            </div>
        </template>
    </div>
</body>

</html>